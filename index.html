<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Chat & Souris ğŸ±ğŸ­</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-database-compat.js"></script>
<script>
  firebase.initializeApp({
    apiKey: "AIzaSyD7GTADWbWIABs5KxyPr-P5IXyYKyfHjnY",
    authDomain: "chat-souris-484f4.firebaseapp.com",
    databaseURL: "https://chat-souris-484f4-default-rtdb.firebaseio.com",
    projectId: "chat-souris-484f4",
    storageBucket: "chat-souris-484f4.firebasestorage.app",
    messagingSenderId: "486094041070",
    appId: "1:486094041070:web:628c595e30ad3c14ad68ff"
  });
  const db = firebase.database();
</script>
<style>
  *{margin:0;padding:0;box-sizing:border-box;}
  body{font-family:'Segoe UI',sans-serif;background:#0f0f1a;color:#fff;height:100vh;overflow:hidden;}
  #app{display:flex;flex-direction:column;height:100vh;}
  .screen{display:none;flex-direction:column;align-items:center;justify-content:center;height:100vh;padding:24px;text-align:center;}
  .screen.active{display:flex;}
  #home{background:linear-gradient(135deg,#1a1a2e,#16213e,#0f3460);}
  .logo{font-size:72px;margin-bottom:16px;animation:bounce 2s infinite;}
  @keyframes bounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-10px)}}
  h1{font-size:2.2rem;font-weight:900;background:linear-gradient(90deg,#e94560,#f5a623);-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:6px;}
  .subtitle{color:#888;margin-bottom:40px;}
  .btn{width:100%;max-width:320px;padding:16px 24px;border-radius:16px;border:none;font-size:1rem;font-weight:700;cursor:pointer;margin:8px 0;transition:all .2s;}
  .btn:active{transform:scale(.97);}
  .btn-primary{background:linear-gradient(135deg,#e94560,#c0392b);color:white;box-shadow:0 4px 20px rgba(233,69,96,.4);}
  .btn-secondary{background:rgba(255,255,255,.08);color:white;border:2px solid rgba(255,255,255,.15);}
  .btn-success{background:linear-gradient(135deg,#27ae60,#2ecc71);color:white;box-shadow:0 4px 20px rgba(39,174,96,.4);}
  .btn-sm{padding:8px 16px;font-size:.85rem;border-radius:10px;}
  .input-field{width:100%;max-width:320px;padding:14px 18px;border-radius:12px;border:2px solid rgba(255,255,255,.12);background:rgba(255,255,255,.05);color:white;font-size:1rem;margin:8px 0;outline:none;}
  .input-field:focus{border-color:#e94560;}
  .input-field::placeholder{color:#555;}
  #zone-screen{padding:0;justify-content:flex-start;}
  #zone-toolbar{padding:12px 16px;background:#1a1a2e;display:flex;align-items:center;gap:10px;flex-wrap:wrap;}
  #zone-toolbar h3{flex:1;font-size:.95rem;}
  #zone-hint{padding:8px 16px;background:rgba(245,166,35,.12);color:#f5a623;font-size:.8rem;border-left:3px solid #f5a623;text-align:left;}
  #map{flex:1;width:100%;min-height:0;}
  #lobby{background:linear-gradient(135deg,#1a1a2e,#0f3460);}
  .room-code{font-size:3rem;font-weight:900;letter-spacing:10px;color:#f5a623;margin:12px 0;font-family:monospace;text-shadow:0 0 30px rgba(245,166,35,.5);}
  .players-list{width:100%;max-width:340px;margin:12px 0;}
  .player-item{display:flex;align-items:center;gap:12px;padding:12px 16px;background:rgba(255,255,255,.05);border-radius:12px;margin:6px 0;}
  .player-avatar{width:38px;height:38px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1.4rem;}
  .player-name{flex:1;font-weight:600;text-align:left;}
  .role-badge-sm{font-size:.72rem;padding:3px 10px;border-radius:20px;font-weight:700;}
  .role-loup{background:#e94560;color:white;}
  .role-souris{background:#27ae60;color:white;}
  #game-screen{padding:0;justify-content:flex-start;}
  #game-header{padding:10px 14px;background:#1a1a2e;display:flex;align-items:center;gap:10px;border-bottom:1px solid rgba(255,255,255,.06);}
  #role-pill{padding:6px 16px;border-radius:20px;font-weight:800;font-size:.85rem;}
  #game-map{flex:1;width:100%;min-height:0;}
  #game-footer{padding:10px 14px;background:#1a1a2e;border-top:1px solid rgba(255,255,255,.06);}
  #touch-btn{display:none;width:100%;padding:18px;border-radius:16px;border:none;background:#333;color:#777;font-size:1rem;font-weight:800;cursor:pointer;transition:all .3s;}
  #touch-btn.ready{background:linear-gradient(135deg,#e94560,#c0392b);color:white;box-shadow:0 4px 20px rgba(233,69,96,.5);animation:rp .8s infinite;}
  @keyframes rp{0%,100%{transform:scale(1)}50%{transform:scale(1.03)}}
  #players-status{display:flex;gap:6px;flex-wrap:wrap;justify-content:center;padding-top:8px;}
  #dist-bar{text-align:center;font-size:.82rem;color:#666;padding:4px 0 2px;min-height:20px;}
  #notif{position:fixed;top:20px;left:50%;transform:translateX(-50%);padding:12px 24px;border-radius:14px;font-weight:700;font-size:.9rem;z-index:9999;display:none;box-shadow:0 4px 24px rgba(0,0,0,.6);max-width:90vw;text-align:center;}
  #oob{position:fixed;bottom:120px;left:50%;transform:translateX(-50%);background:#e94560;color:white;padding:12px 24px;border-radius:14px;font-weight:700;font-size:.9rem;z-index:9999;display:none;animation:pulse 1s infinite;white-space:nowrap;}
  @keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
  .overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;flex-direction:column;z-index:99999;padding:32px;text-align:center;}
  #accept-ov{background:rgba(0,0,0,.95);}
  #accept-ov .big{font-size:88px;animation:bounce .8s infinite;margin-bottom:12px;}
  #accept-ov h2{font-size:1.7rem;font-weight:900;color:#e94560;margin-bottom:6px;}
  #accept-ov .who{font-size:1.3rem;font-weight:700;color:#f5a623;margin:8px 0 24px;}
  #accept-btn{width:100%;max-width:280px;padding:20px;border-radius:16px;border:none;background:linear-gradient(135deg,#e94560,#c0392b);color:white;font-size:1.1rem;font-weight:900;cursor:pointer;animation:rp .8s infinite;}
  #role-ov{background:rgba(0,0,0,.9);}
  #role-ov .big{font-size:88px;margin-bottom:12px;}
  #role-ov h2{font-size:1.8rem;font-weight:900;margin-bottom:8px;}
  #role-ov p{color:#aaa;margin-bottom:32px;}
</style>
</head>
<body>
<div id="notif"></div>
<div id="oob">âš ï¸ Tu sors du pÃ©rimÃ¨tre !</div>
<div id="accept-ov" class="overlay">
  <div class="big">ğŸ±</div>
  <h2>Tu es TOUCHÃ‰ !</h2>
  <p style="color:#aaa;">AttrapÃ© par</p>
  <div class="who" id="catcher-name"></div>
  <p style="color:#666;font-size:.85rem;margin-bottom:24px;">Tu deviens le loup ğŸ±<br>Confirme !</p>
  <button id="accept-btn" onclick="acceptLoup()">ğŸ± Je suis le nouveau LOUP !</button>
</div>
<div id="role-ov" class="overlay">
  <div class="big" id="ro-emoji"></div>
  <h2 id="ro-title"></h2>
  <p id="ro-sub"></p>
  <button class="btn btn-primary" style="max-width:240px;" onclick="this.closest('.overlay').style.display='none'">C'est parti !</button>
</div>
<div id="app">
  <div id="home" class="screen active">
    <div class="logo">ğŸ±ğŸ­</div>
    <h1>Chat &amp; Souris</h1>
    <p class="subtitle">Le loup version GPS</p>
    <button class="btn btn-primary" onclick="showScreen('create')">ğŸ® CrÃ©er une partie</button>
    <button class="btn btn-secondary" onclick="showScreen('join')">ğŸ”— Rejoindre une partie</button>
  </div>
  <div id="create" class="screen" style="background:#0f0f1a;">
    <div style="font-size:52px;margin-bottom:16px;">ğŸ²</div>
    <h2 style="font-size:1.5rem;margin-bottom:6px;">Nouvelle partie</h2>
    <p style="color:#777;margin-bottom:28px;font-size:.9rem;">Tu seras le premier ğŸ± Loup</p>
    <input class="input-field" id="creator-name" placeholder="Ton prÃ©nom" maxlength="15"/>
    <button class="btn btn-primary" onclick="createGame()">DÃ©finir la zone â†’</button>
    <button class="btn btn-secondary" style="margin-top:6px;" onclick="showScreen('home')">â† Retour</button>
  </div>
  <div id="join" class="screen" style="background:#0f0f1a;">
    <div style="font-size:52px;margin-bottom:16px;">ğŸ”</div>
    <h2 style="font-size:1.5rem;margin-bottom:6px;">Rejoindre</h2>
    <p style="color:#777;margin-bottom:28px;font-size:.9rem;">Entre le code donnÃ© par le crÃ©ateur</p>
    <input class="input-field" id="join-name" placeholder="Ton prÃ©nom" maxlength="15"/>
    <input class="input-field" id="join-code" placeholder="CODE" maxlength="4" style="text-transform:uppercase;letter-spacing:8px;font-size:1.4rem;font-weight:900;text-align:center;font-family:monospace;"/>
    <button class="btn btn-success" onclick="joinGame()">Rejoindre â†’</button>
    <button class="btn btn-secondary" style="margin-top:6px;" onclick="showScreen('home')">â† Retour</button>
  </div>
  <div id="zone-screen" class="screen" style="flex-direction:column;">
    <div id="zone-toolbar">
      <h3>ğŸ“ Trace la zone de jeu</h3>
      <button class="btn btn-secondary btn-sm" onclick="clearZone()">Effacer</button>
      <button class="btn btn-success btn-sm" onclick="confirmZone()">âœ“ Confirmer</button>
    </div>
    <div id="zone-hint">Appuie sur la carte pour placer les coins (min. 3 points)</div>
    <div id="map"></div>
  </div>
  <div id="lobby" class="screen">
    <h2 style="font-size:1.4rem;margin-bottom:4px;">Salle d'attente</h2>
    <p style="color:#666;font-size:.85rem;">Partage ce code Ã  tes amis</p>
    <div class="room-code" id="display-code">----</div>
    <div id="players-list" class="players-list"></div>
    <div id="lobby-actions"></div>
  </div>
  <div id="game-screen" class="screen" style="flex-direction:column;">
    <div id="game-header">
      <span id="role-pill">ğŸ± Loup</span>
      <span style="flex:1;font-size:.8rem;color:#777;padding-left:8px;"></span>
    </div>
    <div id="game-map"></div>
    <div id="game-footer">
      <div id="dist-bar"></div>
      <button id="touch-btn" onclick="touchPlayer()">ğŸ¾ Approche-toiâ€¦</button>
      <div id="players-status"></div>
    </div>
  </div>
</div>
<script>
const S={name:'',id:'',code:'',isCreator:false,isLoup:false,started:false,zone:[],myLat:null,myLng:null,pendingTarget:null};
let zMap=null,gMap=null,zPoints=[],zMarkers=[],zPoly=null,myMarker=null,otherMarkers={},roomRef=null,lastTouchTs=null;
const $=id=>document.getElementById(id);
function genId(){return Math.random().toString(36).substr(2,9);}
function genCode(){const c='ABCDEFGHJKLMNPQRSTUVWXYZ';return Array.from({length:4},()=>c[Math.floor(Math.random()*c.length)]).join('');}
function showNotif(msg,bg='#f5a623',fg){const el=$('notif');el.textContent=msg;el.style.background=bg;el.style.color=fg||(bg==='#f5a623'?'#000':'#fff');el.style.display='block';clearTimeout(el._t);el._t=setTimeout(()=>el.style.display='none',4000);}
function showScreen(id){document.querySelectorAll('.screen').forEach(s=>{s.style.display='none';s.classList.remove('active');});const el=$(id);el.style.display='flex';el.classList.add('active');}

function listenRoom(code){
  roomRef=db.ref('rooms/'+code);
  roomRef.on('value',snap=>{
    const room=snap.val();
    if(!room)return;
    if(!S.started)renderLobby(room);
    else syncGame(room);
  });
}

function createGame(){
  const n=$('creator-name').value.trim();if(!n){showNotif('Entre ton prÃ©nom !','#e94560');return;}
  S.name=n;S.id=genId();S.code=genCode();S.isCreator=true;S.isLoup=true;
  showScreen('zone-screen');setTimeout(initZoneMap,80);
}
function initZoneMap(){
  if(zMap){zMap.remove();zMap=null;}zPoints=[];zMarkers=[];zPoly=null;
  zMap=L.map('map');
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'Â© OSM'}).addTo(zMap);
  navigator.geolocation?.getCurrentPosition(p=>zMap.setView([p.coords.latitude,p.coords.longitude],18),()=>zMap.setView([48.8566,2.3522],16));
  zMap.on('click',e=>addZPt(e.latlng));
}
function addZPt(ll){zPoints.push(ll);zMarkers.push(L.circleMarker(ll,{radius:7,color:'#f5a623',fillColor:'#f5a623',fillOpacity:1}).addTo(zMap));if(zPoly)zMap.removeLayer(zPoly);if(zPoints.length>=3)zPoly=L.polygon(zPoints,{color:'#e94560',fillColor:'#e94560',fillOpacity:.15,weight:2,dashArray:'6'}).addTo(zMap);}
function clearZone(){zPoints=[];zMarkers.forEach(m=>zMap.removeLayer(m));zMarkers=[];if(zPoly){zMap.removeLayer(zPoly);zPoly=null;}}
function confirmZone(){
  if(zPoints.length<3){showNotif('Place au moins 3 points !','#e94560');return;}
  S.zone=zPoints.map(p=>({lat:p.lat,lng:p.lng}));
  const room={code:S.code,zone:S.zone,started:false,loupId:S.id,touchRequest:null,
    players:{[S.id]:{name:S.name,isLoup:true,lat:null,lng:null}}};
  listenRoom(S.code);
  db.ref('rooms/'+S.code).set(room);
  openLobby();
}

function joinGame(){
  const n=$('join-name').value.trim(),c=$('join-code').value.trim().toUpperCase();
  if(!n){showNotif('Entre ton prÃ©nom !','#e94560');return;}
  if(c.length!==4){showNotif('Code Ã  4 lettres !','#e94560');return;}
  S.name=n;S.id=genId();S.code=c;
  db.ref('rooms/'+c).once('value',snap=>{
    const room=snap.val();
    if(!room){showNotif('Partie introuvable !','#e94560');return;}
    if(room.started){showNotif('Partie dÃ©jÃ  commencÃ©e !','#e94560');return;}
    S.zone=room.zone;
    db.ref('rooms/'+c+'/players/'+S.id).set({name:S.name,isLoup:false,lat:null,lng:null});
    listenRoom(c);
    openLobby();
  });
}

function openLobby(){showScreen('lobby');$('display-code').textContent=S.code;}
function renderLobby(room){
  if(room.started&&!S.started){launchGame(room);return;}
  const av=['ğŸ­','ğŸ¹','ğŸ°','ğŸ¦Š','ğŸ»','ğŸ¼','ğŸ¨','ğŸ¯'],en=Object.entries(room.players||{});
  $('players-list').innerHTML=en.map(([id,p],i)=>`<div class="player-item"><div class="player-avatar" style="background:${p.isLoup?'rgba(233,69,96,.15)':'rgba(39,174,96,.15)'}">${p.isLoup?'ğŸ±':av[i%av.length]}</div><span class="player-name">${p.name}${id===S.id?' <span style="color:#555;font-size:.75rem;">(toi)</span>':''}</span><span class="role-badge-sm ${p.isLoup?'role-loup':'role-souris'}">${p.isLoup?'ğŸ± Loup':'ğŸ­ Souris'}</span></div>`).join('');
  $('lobby-actions').innerHTML=S.isCreator?(en.length>=2?`<button class="btn btn-success" onclick="startGameNow()">ğŸš€ Lancer (${en.length} joueurs)</button>`:`<p style="color:#555;font-size:.85rem;margin-top:8px;">En attente de joueurs...</p>`):`<p style="color:#555;font-size:.85rem;margin-top:8px;">En attente du crÃ©ateur...</p>`;
}
function startGameNow(){db.ref('rooms/'+S.code+'/started').set(true);}

function launchGame(room){
  S.started=true;S.isLoup=(room.loupId===S.id);S.zone=room.zone||S.zone;
  showRoleOverlay(S.isLoup);showScreen('game-screen');renderRolePill();
  setTimeout(initGameMap,80);startGPS();
}
function showRoleOverlay(isLoup){$('ro-emoji').textContent=isLoup?'ğŸ±':'ğŸ­';$('ro-title').textContent=isLoup?'Tu es le LOUP !':'Tu es une SOURIS !';$('ro-sub').textContent=isLoup?'Approche-toi des souris !':'Cours ! Ã‰vite le loup !';$('role-ov').style.display='flex';}
function renderRolePill(){const p=$('role-pill');if(S.isLoup){p.textContent='ğŸ± LOUP';p.style.background='#e94560';p.style.color='#fff';$('touch-btn').style.display='block';}else{p.textContent='ğŸ­ SOURIS';p.style.background='#27ae60';p.style.color='#fff';$('touch-btn').style.display='none';}}
function initGameMap(){
  if(gMap){gMap.remove();gMap=null;}otherMarkers={};myMarker=null;
  gMap=L.map('game-map');
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'Â© OSM'}).addTo(gMap);
  if(S.zone&&S.zone.length>=3){const poly=L.polygon(S.zone.map(p=>[p.lat,p.lng]),{color:'#e94560',fillColor:'#e94560',fillOpacity:.1,weight:2,dashArray:'5'}).addTo(gMap);gMap.fitBounds(poly.getBounds(),{padding:[30,30]});}
}
const mkIcon=(col,em)=>L.divIcon({html:`<div style="background:${col};width:28px;height:28px;border-radius:50%;border:3px solid white;box-shadow:0 2px 10px rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;font-size:13px;">${em}</div>`,className:'',iconSize:[28,28],iconAnchor:[14,14]});
function refreshMyMarker(){if(!gMap||!S.myLat)return;const ll=[S.myLat,S.myLng];if(!myMarker){myMarker=L.marker(ll,{icon:mkIcon(S.isLoup?'#e94560':'#27ae60',S.isLoup?'ğŸ±':'ğŸ­')}).addTo(gMap).bindPopup(S.name+' (toi)');gMap.setView(ll,18);}else myMarker.setLatLng(ll);}

function startGPS(){
  if(!navigator.geolocation){showNotif('GPS indisponible','#e94560');return;}
  navigator.geolocation.watchPosition(p=>{
    S.myLat=p.coords.latitude;S.myLng=p.coords.longitude;
    if(S.started)db.ref('rooms/'+S.code+'/players/'+S.id).update({lat:S.myLat,lng:S.myLng});
    refreshMyMarker();checkBounds();if(S.isLoup)updateTouchBtn();
  },()=>showNotif('Erreur GPS !','#e94560'),{enableHighAccuracy:true,maximumAge:3000,timeout:12000});
}

function updateTouchBtn(){
  const r=db.ref('rooms/'+S.code);
  r.once('value',snap=>{
    const room=snap.val();if(!room||room.touchRequest)return;
    let best=null,bestD=Infinity;
    Object.entries(room.players||{}).forEach(([id,p])=>{if(id===S.id||id===room.loupId||!p.lat)return;const d=hav(S.myLat,S.myLng,p.lat,p.lng);if(d<bestD){bestD=d;best={id,name:p.name,d};}});
    const btn=$('touch-btn'),dbar=$('dist-bar');
    if(!best){btn.textContent='ğŸ¾ Approche-toiâ€¦';btn.classList.remove('ready');dbar.textContent='';S.pendingTarget=null;return;}
    const dm=Math.round(best.d);
    if(best.d<=10){btn.textContent=`ğŸ‘‹ TOUCHER ${best.name} ! (${dm}m)`;btn.classList.add('ready');dbar.innerHTML=`<span style="color:#e94560;font-weight:700;">ğŸ”´ ${best.name} Ã  ${dm}m â€” TOUCHE !</span>`;S.pendingTarget=best;}
    else if(best.d<=40){btn.textContent=`ğŸ¾ Rapproche-toi de ${best.name}â€¦ (${dm}m)`;btn.classList.remove('ready');dbar.innerHTML=`<span style="color:#f5a623;">ğŸŸ  ${best.name} Ã  ${dm}m</span>`;S.pendingTarget=null;}
    else{btn.textContent='ğŸ¾ Approche-toiâ€¦';btn.classList.remove('ready');dbar.innerHTML=`<span style="color:#666;">âšª Souris la plus proche : ${dm}m</span>`;S.pendingTarget=null;}
  });
}
function touchPlayer(){
  if(!S.isLoup||!S.pendingTarget){showNotif('Approche-toi Ã  moins de 10m !','#888','#fff');return;}
  db.ref('rooms/'+S.code+'/touchRequest').set({fromId:S.id,fromName:S.name,toId:S.pendingTarget.id,ts:Date.now()});
  showNotif(`Demande envoyÃ©e Ã  ${S.pendingTarget.name} !`,'#f5a623');
  $('touch-btn').textContent='â³ En attenteâ€¦';$('touch-btn').classList.remove('ready');
}

function syncGame(room){
  if(!S.isLoup&&room.touchRequest&&room.touchRequest.toId===S.id&&room.touchRequest.ts!==lastTouchTs){
    lastTouchTs=room.touchRequest.ts;
    $('catcher-name').textContent=room.touchRequest.fromName;
    $('accept-ov').style.display='flex';
    if(navigator.vibrate)navigator.vibrate([300,100,300,100,300]);
  }
  const wasLoup=S.isLoup;S.isLoup=(room.loupId===S.id);
  if(!wasLoup&&S.isLoup){showNotif('ğŸ± Tu es le LOUP !','#e94560');showRoleOverlay(true);renderRolePill();if(myMarker){gMap.removeLayer(myMarker);myMarker=null;}refreshMyMarker();}
  if(gMap){
    Object.entries(room.players||{}).forEach(([id,p])=>{
      if(id===S.id)return;
      const isL=(id===room.loupId);
      if(!S.isLoup&&isL){if(otherMarkers[id]){gMap.removeLayer(otherMarkers[id]);delete otherMarkers[id];}return;}
      if(!p.lat||!p.lng)return;
      if(!otherMarkers[id]){otherMarkers[id]=L.marker([p.lat,p.lng],{icon:mkIcon(isL?'#e94560':'#27ae60',isL?'ğŸ±':'ğŸ­')}).addTo(gMap).bindPopup(p.name);}
      else otherMarkers[id].setLatLng([p.lat,p.lng]);
    });
  }
  $('players-status').innerHTML=Object.entries(room.players||{}).map(([id,p])=>{const l=(id===room.loupId);return`<span style="padding:3px 10px;border-radius:20px;background:${l?'rgba(233,69,96,.2)':'rgba(39,174,96,.2)'};font-size:.72rem;border:1px solid ${l?'#e94560':'#27ae60'};color:${l?'#e94560':'#27ae60'};">${l?'ğŸ±':'ğŸ­'} ${p.name}${id===S.id?' â˜…':''}</span>`;}).join('');
  if(S.isLoup)updateTouchBtn();
}
function acceptLoup(){
  db.ref('rooms/'+S.code).once('value',snap=>{
    const r=snap.val();if(!r?.touchRequest)return;
    const prev=r.loupId;
    db.ref('rooms/'+S.code).update({loupId:S.id,touchRequest:null,['players/'+prev+'/isLoup']:false,['players/'+S.id+'/isLoup']:true});
  });
  $('accept-ov').style.display='none';lastTouchTs=null;
}
function checkBounds(){if(!S.myLat||!S.zone||S.zone.length<3)return;$('oob').style.display=inPoly(S.myLat,S.myLng,S.zone)?'none':'block';}
function inPoly(lat,lng,poly){let ins=false,n=poly.length;for(let i=0,j=n-1;i<n;j=i++){const xi=poly[i].lat,yi=poly[i].lng,xj=poly[j].lat,yj=poly[j].lng;if(((yi>lng)!==(yj>lng))&&(lat<(xj-xi)*(lng-yi)/(yj-yi)+xi))ins=!ins;}return ins;}
function hav(a,b,c,d){const R=6371000,dl=(c-a)*Math.PI/180,dn=(d-b)*Math.PI/180,x=Math.sin(dl/2)**2+Math.cos(a*Math.PI/180)*Math.cos(c*Math.PI/180)*Math.sin(dn/2)**2;return R*2*Math.atan2(Math.sqrt(x),Math.sqrt(1-x));}
showScreen('home');
</script>
</body>
</html>
